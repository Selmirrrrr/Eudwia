@page "/members/{MemberId:guid}"
@using MosqueLife.Client.Extensions
@using MosqueLife.Shared.Features.Account.Update
@using MosqueLife.Shared.Features.Account.Details
@using MosqueLife.Shared.Features.Countries.List;
@using MosqueLife.Shared.Features.Members.Details
@using System.Globalization
@using MosqueLife.Shared.Enums
@inject HttpClient _httpClient
@inject ISnackbar _snackbar
@inject AuthenticationStateProvider _getAuthenticationStateAsync

@attribute [Authorize]

<AuthorizeView>
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4">Membre</MudText>
    <MudTabs Elevation="1" Rounded="true" PanelClass="mt-6">
        <MudTabPanel Text="Général">
            <MudForm Model="@_model" @ref="@_form">
                <MudGrid>
                    <MudItem xs="12" sm="12" md="12">
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText>Personnel</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_model.Firstname" Label="Prénom"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_model.Lastname" Label="Nom"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudDatePicker Label="Date de naissance" @bind-Date="_model.BirthDate"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudDatePicker Label="Membre depuis" @bind-Date="_model.MemberSince"/>
                                    </MudItem>
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="12" md="12">
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText>Adresse</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12" md="5">
                                        <MudTextField @bind-Value="_model.StreetLine1" Label="Rue 1"/>
                                    </MudItem>
                                    <MudItem xs="12" md="1">
                                        <MudTextField @bind-Value="_model.HouseNumber" Label="N°"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_model.StreetLine2" Label="Rue 2"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_model.ZipCode" Label="NPA"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_model.City" Label="Ville"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_model.State" Label="Canton"/>
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudSelect T="Guid" @bind-Value="@_model.CountryId" Label="Pays" AnchorOrigin="Origin.BottomCenter">
                                            @foreach (var country in _countries)
                                            {
                                                <MudSelectItem T="Guid" Value="@country.Id">@country.Name</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudItem>
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="12" md="12">
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText>Contact</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12" md="5">
                                        <MudTextField @bind-Value="_model.Email" Label="Email" Adornment="Adornment.End" AdornmentIcon="@Icons.Filled.Email"/>
                                    </MudItem>
                                    <MudItem xs="12" md="5">
                                        <MudTextField @bind-Value="_model.PhoneNumber" Label="Téléphone" Adornment="Adornment.End" AdornmentIcon="@Icons.Filled.Phone"/>
                                    </MudItem>
                                    <MudItem xs="12" md="2">
                                        <MudSelect T="Language" @bind-Value="@_model.Language" Label="Langue" AnchorOrigin="Origin.BottomCenter">
                                            @foreach (var language in Enum.GetValues<Language>())
                                            {
                                                <MudSelectItem T="Language" Value="@language">@language.ToString()</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudItem>
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudTabPanel>
        <MudTabPanel Text="Cotisations">
            <MudText>Content Three</MudText>
        </MudTabPanel>
        <MudTabPanel Text="Payments">
            <MudText>Content Three</MudText>
        </MudTabPanel>
        <MudTabPanel Text="Compte">
            <MudText>Content Three</MudText>
        </MudTabPanel>
    </MudTabs>
</AuthorizeView>

@code {

    [Parameter]
    public Guid MemberId { get; set; }

    private MudForm _form { get; set; } = default!;
    private MembersDetailsViewModel _model = new();
    private IEnumerable<CountriesListViewModel> _countries = new List<CountriesListViewModel>();

    protected override async Task OnInitializedAsync()
    {
        _model = await _httpClient.GetFromJsonAsync<MembersDetailsViewModel>($"api/members/{MemberId}") ?? new MembersDetailsViewModel();
        _countries = (await _httpClient.GetFromJsonAsync<List<CountriesListViewModel>>("api/countries") ?? new List<CountriesListViewModel>()).OrderBy(c => c.Name);
    }

    private async Task<IEnumerable<CountriesListViewModel>> SearchCountry(string value)
    {
    // if text is null or empty, show complete list
        if (string.IsNullOrEmpty(value))
            return _countries;
        return _countries.Where(x => x.Name.StartsWith(value, StringComparison.InvariantCultureIgnoreCase));
    }

}